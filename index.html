<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Playlists - MoodPlaylist</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide Icons (simplificados como SVG components)
        const Music = ({ className, ...props }) => (
            <svg className={className} {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
            </svg>
        );

        const User = ({ className, ...props }) => (
            <svg className={className} {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
        );

        const LogIn = ({ className, ...props }) => (
            <svg className={className} {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
            </svg>
        );

        const UserPlus = ({ className, ...props }) => (
            <svg className={className} {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
            </svg>
        );

        const Home = ({ className, ...props }) => (
            <svg className={className} {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
        );

        const Share2 = ({ className, ...props }) => (
            <svg className={className} {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
            </svg>
        );

        const Heart = ({ className, ...props }) => (
            <svg className={className} {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
            </svg>
        );

        const TrendingUp = ({ className, ...props }) => (
            <svg className={className} {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
            </svg>
        );

        const LogOut = ({ className, ...props }) => (
            <svg className={className} {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
        );

        const Sparkles = ({ className, ...props }) => (
            <svg className={className} {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
            </svg>
        );

        const Search = ({ className, ...props }) => (
            <svg className={className} {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        );

        const MOOD_DATABASE = {
          'feliz': { genres: ['pop', 'dance', 'funk'], energy: 'high', tempo: 'fast', keywords: ['happy', 'upbeat', 'cheerful'] },
          'triste': { genres: ['acoustic', 'indie', 'sad'], energy: 'low', tempo: 'slow', keywords: ['sad', 'melancholic', 'emotional'] },
          'relajado': { genres: ['lofi', 'chill', 'ambient'], energy: 'low', tempo: 'medium', keywords: ['chill', 'relax', 'calm'] },
          'en√©rgico': { genres: ['electronic', 'rock', 'workout'], energy: 'high', tempo: 'fast', keywords: ['energetic', 'power', 'intense'] },
          'concentrado': { genres: ['classical', 'ambient', 'instrumental'], energy: 'medium', tempo: 'medium', keywords: ['focus', 'study', 'concentration'] },
          'rom√°ntico': { genres: ['r&b', 'soul', 'love songs'], energy: 'medium', tempo: 'slow', keywords: ['love', 'romantic', 'passion'] },
          'nost√°lgico': { genres: ['80s', '90s', 'oldies'], energy: 'medium', tempo: 'medium', keywords: ['throwback', 'nostalgia', 'memories'] },
          'motivado': { genres: ['hip hop', 'rock', 'motivational'], energy: 'high', tempo: 'fast', keywords: ['motivation', 'hustle', 'workout'] },
          'ansioso': { genres: ['meditation', 'nature sounds', 'calm'], energy: 'low', tempo: 'slow', keywords: ['anxiety relief', 'peaceful', 'breathe'] },
          'aburrido': { genres: ['indie', 'alternative', 'discover'], energy: 'medium', tempo: 'varied', keywords: ['discovery', 'new music', 'fresh'] }
        };
// Bot√≥n coraz√≥n para cada canci√≥n
function LikeButton({ track, userId, isLiked, onLikeChange, mood }) {
  const [loading, setLoading] = useState(false);

  const toggleLike = async () => {
    if (!userId) {
      alert("Debes iniciar sesi√≥n para marcar canciones como favoritas");
      return;
    }
    if (loading) return;

    setLoading(true);

    try {
      if (isLiked) {
        // Quitar like
        const res = await fetch(
          `http://localhost:3000/api/songs/unlike/${userId}/${track.id}`,
          { method: "DELETE" }
        );
        if (!res.ok) throw new Error("Error al quitar like");
        onLikeChange && onLikeChange(track, false, mood);
      } else {
        // Dar like
        const res = await fetch("http://localhost:3000/api/songs/like", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: userId,
            track_id: track.id,
            track_name: track.name,
            artist: track.artist,
            album: track.album,
            image: track.image,
            mood
          })
        });
        if (!res.ok) throw new Error("Error al guardar like");
        onLikeChange && onLikeChange(track, true, mood);
      }
    } catch (error) {
      console.error(error);
      alert(error.message || "Error al actualizar favorito");
    } finally {
      setLoading(false);
    }
  };

  return (
    <button
      type="button"
      onClick={toggleLike}
      disabled={loading}
      className={
        "flex items-center gap-1 text-sm transform transition-transform " +
        (isLiked ? "text-red-500" : "text-gray-300") +
        " hover:scale-110 active:scale-95 disabled:opacity-60"
      }
    >
      <span className="text-lg">{isLiked ? "‚ù§Ô∏è" : "ü§ç"}</span>
      <span className="hidden sm:inline">
        {isLiked ? "Quitar" : "Like"}
      </span>
    </button>
  );
}

        /**********************************************
         COMPONENTES REUTILIZABLES (FUERA DEL PRINCIPAL)
        **********************************************/
        function LoginView({ loginData, setLoginData, handleLogin, setView }) {
          return (
            <div className="max-w-md mx-auto mt-20 p-8 bg-white rounded-2xl shadow-2xl">
              <div className="text-center mb-8">
                <Music className="w-16 h-16 mx-auto text-green-500 mb-4" />
                <h2 className="text-3xl font-bold text-gray-800">Iniciar Sesi√≥n</h2>
              </div>
              <div className="space-y-4">
                <input
                  type="email"
                  value={loginData.email}
                  onChange={(e) => setLoginData({ ...loginData, email: e.target.value })}
                  placeholder="Email"
                  className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
                />
                <input
                  type="password"
                  value={loginData.password}
                  onChange={(e) => setLoginData({ ...loginData, password: e.target.value })}
                  placeholder="Contrase√±a"
                  className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
                />
                <button onClick={handleLogin} className="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition">
                  Iniciar Sesi√≥n
                </button>
              </div>
              <p className="text-center mt-4 text-gray-600">
                ¬øNo tienes cuenta?{" "}
                <button onClick={() => setView("register")} className="text-green-500 hover:underline">
                  Reg√≠strate
                </button>
              </p>
              <p className="text-center mt-2 text-sm text-gray-500">
                Demo: demo@playlist.com / demo123
              </p>
            </div>
          );
        }

        function RegisterView({ registerData, setRegisterData, handleRegister, setView }) {
          return (
            <div className="max-w-md mx-auto mt-20 p-8 bg-white rounded-2xl shadow-2xl">
              <div className="text-center mb-8">
                <UserPlus className="w-16 h-16 mx-auto text-green-500 mb-4" />
                <h2 className="text-3xl font-bold text-gray-800">Crear Cuenta</h2>
              </div>
              <div className="space-y-4">
                <input
                  type="text"
                  value={registerData.name}
                  onChange={(e) => setRegisterData({ ...registerData, name: e.target.value })}
                  placeholder="Nombre completo"
                  className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
                />
                <input
                  type="email"
                  value={registerData.email}
                  onChange={(e) => setRegisterData({ ...registerData, email: e.target.value })}
                  placeholder="Email"
                  className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
                />
                <input
                  type="password"
                  value={registerData.password}
                  onChange={(e) => setRegisterData({ ...registerData, password: e.target.value })}
                  placeholder="Contrase√±a"
                  className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
                />
                <button onClick={handleRegister} className="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition">
                  Registrarse
                </button>
              </div>
              <p className="text-center mt-4 text-gray-600">
                ¬øYa tienes cuenta?{" "}
                <button onClick={() => setView("login")} className="text-green-500 hover:underline">
                  Inicia sesi√≥n
                </button>
              </p>
            </div>
          );
        }

        function MoodQuickButton({ mood, onClick }) {
          const emojis = {
            'feliz': 'üòä',
            'triste': 'üò¢',
            'relajado': 'üòå',
            'en√©rgico': '‚ö°',
            'concentrado': 'üéØ',
            'rom√°ntico': '‚ù§Ô∏è',
            'nost√°lgico': 'üåÖ',
            'motivado': 'üí™',
            'ansioso': 'üò∞',
            'aburrido': 'üòê'
          };

          return (
            <button
              onClick={onClick}
              className="bg-white p-4 rounded-xl shadow-lg hover:scale-105 transition transform hover:shadow-xl"
            >
              <div className="text-3xl mb-2">{emojis[mood]}</div>
              <p className="text-sm font-semibold text-gray-800 capitalize">{mood}</p>
            </button>
          );
        }

function HomeView({ userMood, setUserMood, generatePlaylistFromMood, isGenerating, recommendations }) {
  return (
    <div className="max-w-4xl mx-auto mt-10 p-8">
      <div className="text-center mb-12">
        <h1 className="text-5xl font-bold mb-4 bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
          ¬øC√≥mo te sientes hoy?
        </h1>
        <p className="text-gray-600 text-lg">
          Cu√©ntanos tu estado de √°nimo y te recomendaremos la playlist perfecta
        </p>
      </div>

      {/* üî• Recomendaciones inteligentes */}
      {recommendations && recommendations.recommendedMoods?.length > 0 && (
        <div className="max-w-2xl mx-auto mb-8">
          <div className="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-xl shadow">
            <h3 className="text-lg font-semibold text-gray-800 flex items-center gap-2">
              <Sparkles className="w-5 h-5 text-purple-500" />
              Recomendado para ti
            </h3>
            <p className="text-gray-600 mt-2">{recommendations.message}</p>

            <div className="flex flex-wrap gap-2 mt-4">
              {recommendations.recommendedMoods.map((mood) => (
                <button
                  key={mood}
                  onClick={() => {
                    setUserMood(mood);
                    setTimeout(() => generatePlaylistFromMood(), 100);
                  }}
                  className="px-3 py-1 rounded-full bg-white/80 text-sm font-semibold shadow border border-pink-100 hover:scale-105 transition transform capitalize"
                >
                  {mood}{" "}
                  {recommendations.stats && recommendations.stats[mood] && (
                    <span className="ml-1 text-xs text-pink-500">
                      ({recommendations.stats[mood]} ‚ù§Ô∏è)
                    </span>
                  )}
                </button>
              ))}
            </div>
          </div>
        </div>
      )}

      <div className="max-w-2xl mx-auto mb-12">
        <div className="bg-white rounded-2xl shadow-2xl p-8">
          <div className="flex gap-4">
            <input
              type="text"
              value={userMood}
              onChange={(e) => setUserMood(e.target.value)}
              onKeyPress={(e) => e.key === "Enter" && generatePlaylistFromMood()}
              placeholder="Ej: feliz, triste, relajado, motivado..."
              className="flex-1 p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none text-lg"
            />
            <button
              onClick={generatePlaylistFromMood}
              disabled={isGenerating}
              className="bg-green-500 text-white px-8 py-4 rounded-xl hover:bg-green-600 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {isGenerating ? (
                <>
                  <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                  Generando...
                </>
              ) : (
                <>
                  <Search className="w-5 h-5" />
                  Generar
                </>
              )}
            </button>
          </div>
        </div>
      </div>

      <div className="mb-8">
        <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">O elige un estado de √°nimo</h2>
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
          {Object.keys(MOOD_DATABASE).map((mood) => (
            <MoodQuickButton
              key={mood}
              mood={mood}
              onClick={() => {
                setUserMood(mood);
                setTimeout(() => generatePlaylistFromMood(), 100);
              }}
            />
          ))}
        </div>
      </div>
    </div>
  );
}

 function PlaylistView({
  generatedPlaylist,
  user,
  savePlaylist,
  sharePlaylist,
  exportToSpotify,
  setView,
  likedTrackIds,
  onLikeChange
}) {
  if (!generatedPlaylist) return null;

  return (
    <div className="max-w-4xl mx-auto mt-10 p-8">
      <div className="bg-white rounded-2xl shadow-2xl p-8">
        <div className="flex justify-between items-center mb-6">
          <div>
            <h2 className="text-3xl font-bold text-gray-800">{generatedPlaylist.name}</h2>
            <p className="text-gray-500 mt-1">
              Basado en:{" "}
              <span className="font-semibold capitalize">
                {generatedPlaylist.originalInput}
              </span>
            </p>
          </div>
          <button onClick={() => setView("home")} className="text-gray-500 hover:text-gray-700">
            ‚Üê Volver
          </button>
        </div>

        <div className="flex gap-4 mb-8 flex-wrap">
          {user ? (
            <>
              <button
                onClick={savePlaylist}
                className="flex items-center gap-2 bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition"
              >
                <Heart className="w-4 h-4" /> Guardar
              </button>
              <button
                onClick={() => sharePlaylist(generatedPlaylist)}
                className="flex items-center gap-2 bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition"
              >
                <Share2 className="w-4 h-4" /> Compartir
              </button>
              <button
                onClick={exportToSpotify}
                className="flex items-center gap-2 bg-black text-white px-6 py-3 rounded-lg hover:bg-gray-800 transition"
              >
                <Music className="w-4 h-4" /> Exportar a Spotify
              </button>
            </>
          ) : (
            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
              <p className="text-yellow-800">
                üîí <strong>Inicia sesi√≥n</strong> para guardar, compartir y exportar tus playlists
              </p>
            </div>
          )}
        </div>

        <div className="space-y-3">
          {generatedPlaylist.tracks.map((track, idx) => {
            const trackForLike = {
              id: track.id,
              name: track.name,
              artist: track.artist,
              album: track.album,
              image: track.image,
              mood: generatedPlaylist.mood
            };

            return (
              <div
                key={track.id}
                className="flex items-center gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition"
              >
                <span className="text-gray-400 font-bold w-8">{idx + 1}</span>
                {track.image && (
                  <img src={track.image} alt={track.name} className="w-16 h-16 rounded shadow" />
                )}
                <div className="flex-1">
                  <p className="font-semibold text-gray-800">{track.name}</p>
                  <p className="text-sm text-gray-600">
                    {track.artist} ‚Ä¢ {track.album}
                  </p>
                </div>

                {user && (
                  <LikeButton
                    track={trackForLike}
                    userId={user.id}
                    isLiked={likedTrackIds.has(track.id)}
                    mood={generatedPlaylist.mood}
                    onLikeChange={onLikeChange}
                  />
                )}
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}
function LikedSongsView({ userId, likedSongs, setView, likedTrackIds, onLikeChange }) {
  return (
    <div className="max-w-4xl mx-auto mt-10 p-8">
      <div className="bg-white rounded-2xl shadow-2xl p-8">
        <div className="flex justify-between items-center mb-6">
          <div>
            <h2 className="text-3xl font-bold text-gray-800">Mis canciones favoritas</h2>
            <p className="text-gray-500 mt-1">
              {likedSongs.length > 0
                ? `Tienes ${likedSongs.length} canciones marcadas con ‚ù§Ô∏è`
                : "Marca canciones como favoritas desde cualquier playlist"}
            </p>
          </div>
          <button onClick={() => setView("home")} className="text-gray-500 hover:text-gray-700">
            ‚Üê Volver
          </button>
        </div>

        {likedSongs.length === 0 ? (
          <div className="text-center py-12">
            <Heart className="w-16 h-16 mx-auto text-gray-200 mb-4" />
            <p className="text-gray-500 mb-4">
              A√∫n no tienes canciones favoritas.
            </p>
            <button
              onClick={() => setView("home")}
              className="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
            >
              Buscar m√∫sica por estado de √°nimo ‚Üí
            </button>
          </div>
        ) : (
          <div className="space-y-3">
            {likedSongs.map((song, idx) => {
              const track = {
                id: song.track_id,
                name: song.track_name,
                artist: song.artist,
                album: song.album,
                image: song.image,
                mood: song.mood
              };

              return (
                <div
                  key={song.id || song.track_id}
                  className="flex items-center gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition"
                >
                  <span className="text-gray-400 font-bold w-8">{idx + 1}</span>
                  {song.image && (
                    <img src={song.image} alt={song.track_name} className="w-16 h-16 rounded shadow" />
                  )}
                  <div className="flex-1">
                    <p className="font-semibold text-gray-800">{song.track_name}</p>
                    <p className="text-sm text-gray-600">
                      {song.artist} ‚Ä¢ {song.album}
                    </p>
                    {song.mood && (
                      <p className="text-xs text-gray-500 mt-1 capitalize">
                        Mood asociado: {song.mood}
                      </p>
                    )}
                  </div>

                  <LikeButton
                    track={track}
                    userId={userId}
                    isLiked={likedTrackIds.has(song.track_id)}
                    mood={song.mood}
                    onLikeChange={onLikeChange}
                  />
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}
function ProfileView({
  userStats,
  savedPlaylists,
  setView,
  setGeneratedPlaylist,
  sharePlaylist,
  likedSongsCount
}) {
  return (
    <div className="max-w-4xl mx-auto mt-10 p-8">
      <div className="bg-white rounded-2xl shadow-2xl p-8">
        <h2 className="text-3xl font-bold text-gray-800 mb-6">Mi Perfil</h2>

        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div className="bg-green-50 p-6 rounded-xl text-center">
            <TrendingUp className="w-12 h-12 mx-auto text-green-500 mb-2" />
            <p className="text-3xl font-bold text-gray-800">{userStats.totalPlaylists}</p>
            <p className="text-gray-600">Playlists Guardadas</p>
          </div>
          <div className="bg-purple-50 p-6 rounded-xl text-center">
            <Sparkles className="w-12 h-12 mx-auto text-purple-500 mb-2" />
            <p className="text-3xl font-bold text-gray-800">{userStats.favoriteMood}</p>
            <p className="text-gray-600">Estado Favorito</p>
          </div>
          <div className="bg-blue-50 p-6 rounded-xl text-center">
            <Music className="w-12 h-12 mx-auto text-blue-500 mb-2" />
            <p className="text-3xl font-bold text-gray-800">
              {savedPlaylists.reduce((acc, pl) => acc + pl.tracks.length, 0)}
            </p>
            <p className="text-gray-600">Canciones Totales</p>
          </div>
          {/* üß° Nueva estad√≠stica */}
          <div className="bg-red-50 p-6 rounded-xl text-center">
            <Heart className="w-12 h-12 mx-auto text-red-500 mb-2" />
            <p className="text-3xl font-bold text-gray-800">{likedSongsCount}</p>
            <p className="text-gray-600">Canciones Favoritas</p>
          </div>
        </div>

        <h3 className="text-2xl font-bold text-gray-800 mb-4">Mis Playlists</h3>
        <div className="space-y-3">
          {savedPlaylists.length === 0 ? (
            <div className="text-center py-12">
              <Music className="w-16 h-16 mx-auto text-gray-300 mb-4" />
              <p className="text-gray-500">No tienes playlists guardadas a√∫n</p>
              <button
                onClick={() => setView("home")}
                className="mt-4 text-green-500 hover:text-green-600 font-semibold"
              >
                Generar mi primera playlist ‚Üí
              </button>
            </div>
          ) : (
            savedPlaylists.map((pl) => (
              <div
                key={pl.id}
                className="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition"
              >
                <div>
                  <p className="font-semibold text-gray-800">{pl.name}</p>
                  <p className="text-sm text-gray-600">
                    {pl.tracks.length} canciones ‚Ä¢{" "}
                    <span className="capitalize">{pl.mood}</span>
                  </p>
                </div>
                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      setGeneratedPlaylist(pl);
                      setView("playlist");
                    }}
                    className="text-green-500 hover:text-green-600 font-semibold"
                  >
                    Ver
                  </button>
                  <button
                    onClick={() => sharePlaylist(pl)}
                    className="text-blue-500 hover:text-blue-600 font-semibold"
                  >
                    Compartir
                  </button>
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );
}

function Navigation({ user, setView, handleLogout }) {
  return (
    <nav className="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 shadow-lg">
      <div className="max-w-6xl mx-auto flex justify-between items-center">
        <div className="flex items-center gap-2 text-2xl font-bold">
          <Music className="w-8 h-8" />
          MoodPlaylist
        </div>

        <div className="flex items-center gap-6">
          <button
            onClick={() => setView("home")}
            className="flex items-center gap-2 hover:text-green-200 transition"
          >
            <Home className="w-5 h-5" /> Home
          </button>

          {user ? (
            <>
              <button
                onClick={() => setView("profile")}
                className="flex items-center gap-2 hover:text-green-200 transition"
              >
                <User className="w-5 h-5" /> Perfil
              </button>

              {/* ‚ù§Ô∏è Mis favoritas */}
              <button
                onClick={() => setView("liked")}
                className="flex items-center gap-2 hover:text-green-200 transition"
              >
                <Heart className="w-5 h-5" /> Mis Favoritas
              </button>

              <button
                onClick={handleLogout}
                className="flex items-center gap-2 hover:text-green-200 transition"
              >
                <LogOut className="w-5 h-5" /> Salir
              </button>
              <span className="text-sm bg-green-600 px-3 py-1 rounded-full">
                üëã {user.name}
              </span>
            </>
          ) : (
            <>
              <button
                onClick={() => setView("login")}
                className="flex items-center gap-2 hover:text-green-200 transition"
              >
                <LogIn className="w-5 h-5" /> Iniciar Sesi√≥n
              </button>
              <button
                onClick={() => setView("register")}
                className="flex items-center gap-2 hover:text-green-200 transition"
              >
                <UserPlus className="w-5 h-5" /> Registrarse
              </button>
            </>
          )}
        </div>
      </div>
    </nav>
  );
}

        /**********************************************
         COMPONENTE PRINCIPAL
        **********************************************/
        function SpotifyPlaylistGenerator() {
          const [user, setUser] = useState(null);
          const [view, setView] = useState("home");
          const [spotifyToken, setSpotifyToken] = useState(null);
          const [generatedPlaylist, setGeneratedPlaylist] = useState(null);
          const [savedPlaylists, setSavedPlaylists] = useState([]);
          const [userStats, setUserStats] = useState({ totalPlaylists: 0, favoriteMood: "Feliz" });
          const [loginData, setLoginData] = useState({ email: "", password: "" });
          const [registerData, setRegisterData] = useState({ name: "", email: "", password: "" });
          const [userMood, setUserMood] = useState("");
          const [isGenerating, setIsGenerating] = useState(false);
          const [likedSongs, setLikedSongs] = useState([]);
          const [likedTrackIds, setLikedTrackIds] = useState(new Set());
          const [recommendations, setRecommendations] = useState(null);

useEffect(() => {
  getSpotifyToken();
  const savedUser = localStorage.getItem("currentUser");
  if (savedUser) {
    const userData = JSON.parse(savedUser);
    setUser(userData);
    loadUserPlaylists(userData.id);
    loadLikedSongs(userData.id);
    loadRecommendations(userData.id);
  }
}, []);

          const getSpotifyToken = async () => {
            try {
              const response = await fetch("http://localhost:3000/spotify-token");
              const data = await response.json();
              setSpotifyToken(data.access_token);
            } catch (error) {
              console.error("Error obteniendo token desde servidor local:", error);
            }
          };

          const handleLogin = async () => {
            try {
              const res = await fetch("http://localhost:3000/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(loginData)
              });

              const data = await res.json();

if (res.ok) {
  setUser(data);
  localStorage.setItem("currentUser", JSON.stringify(data));
  loadUserPlaylists(data.id);
  loadLikedSongs(data.id);
  loadRecommendations(data.id);
  setView("home");
} else {
  alert(data.error || "Credenciales incorrectas");
}
            } catch (err) {
              alert("Error en login");
            }
          };

          const handleRegister = async () => {
            try {
              const res = await fetch("http://localhost:3000/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(registerData)
              });

              const data = await res.json();

              if (res.ok) {
                setUser(data);
                localStorage.setItem("currentUser", JSON.stringify(data));
                setView("home");
              } else {
                alert(data.error || "No se pudo registrar");
              }
            } catch (err) {
              alert("Error en registro");
            }
          };

          const handleLogout = () => {
  setUser(null);
  localStorage.removeItem("currentUser");
  setView("home");
  setSavedPlaylists([]);
  setLikedSongs([]);
  setLikedTrackIds(new Set());
  setRecommendations(null);
          };

          const loadUserPlaylists = async (userId) => {
            const res = await fetch(`http://localhost:3000/user-playlists/${userId}`);
            const data = await res.json();
            setSavedPlaylists(data);
            calculateStats(data);
          };

          const calculateStats = (playlists) => {
            const moodCount = {};
            playlists.forEach((pl) => {
              moodCount[pl.mood] = (moodCount[pl.mood] || 0) + 1;
            });
            const favMood =
              Object.keys(moodCount).length > 0
                ? Object.keys(moodCount).reduce((a, b) => (moodCount[a] > moodCount[b] ? a : b))
                : "Feliz";

            setUserStats({
              totalPlaylists: playlists.length,
              favoriteMood: favMood.charAt(0).toUpperCase() + favMood.slice(1)
            });
          };

const loadLikedSongs = async (userId) => {
  try {
    const res = await fetch(`http://localhost:3000/api/songs/liked/${userId}`);
    if (!res.ok) throw new Error("Error al cargar likes");
    const data = await res.json();
    setLikedSongs(data);
    setLikedTrackIds(new Set(data.map((s) => s.track_id)));
  } catch (error) {
    console.error("Error cargando liked songs:", error);
  }
};

const loadRecommendations = async (userId) => {
  try {
    const res = await fetch(`http://localhost:3000/api/recommendations/${userId}`);
    if (!res.ok) throw new Error("Error al cargar recomendaciones");
    const data = await res.json();
    if (data && Array.isArray(data.recommendedMoods) && data.recommendedMoods.length > 0) {
      setRecommendations(data);
    } else {
      setRecommendations(null);
    }
  } catch (error) {
    console.error("Error cargando recomendaciones:", error);
  }
};

const handleLikeChange = (track, liked, mood) => {
  setLikedTrackIds((prev) => {
    const next = new Set(prev);
    if (liked) {
      next.add(track.id);
    } else {
      next.delete(track.id);
    }
    return next;
  });

  setLikedSongs((prev) => {
    if (liked) {
      if (prev.some((s) => s.track_id === track.id)) return prev;
      return [
        {
          id: Date.now(),
          track_id: track.id,
          track_name: track.name,
          artist: track.artist,
          album: track.album,
          image: track.image,
          mood: mood || track.mood || "",
          created_at: new Date().toISOString()
        },
        ...prev
      ];
    }
    return prev.filter((s) => s.track_id !== track.id);
  });

  if (user) {
    loadRecommendations(user.id);
  }
};



          const generatePlaylistFromMood = async () => {
            if (!userMood.trim()) {
              alert("Por favor, dinos c√≥mo te sientes");
              return;
            }

            if (!spotifyToken) {
              alert("Esperando conexi√≥n con Spotify. Intenta de nuevo en unos segundos.");
              return;
            }

            setIsGenerating(true);

            const normalizedMood = userMood.toLowerCase().trim();
            let moodConfig = null;
            let detectedMood = normalizedMood;

            for (const [mood, config] of Object.entries(MOOD_DATABASE)) {
              if (normalizedMood.includes(mood) || mood.includes(normalizedMood)) {
                moodConfig = config;
                detectedMood = mood;
                break;
              }
            }

            if (!moodConfig) {
              moodConfig = {
                genres: ["pop"],
                energy: "medium",
                tempo: "medium",
                keywords: [normalizedMood]
              };
            }

            try {
              const allTracks = [];

              for (const genre of moodConfig.genres.slice(0, 2)) {
                const searchQuery = `${genre} ${moodConfig.keywords[0]}`;
                const response = await fetch(
                  `https://api.spotify.com/v1/search?q=${encodeURIComponent(
                    searchQuery
                  )}&type=track&limit=8`,
                  {
                    headers: {
                      Authorization: `Bearer ${spotifyToken}`
                    }
                  }
                );

                const data = await response.json();
                if (data.tracks && data.tracks.items) {
                  allTracks.push(...data.tracks.items);
                }
              }

              const uniqueTracks = Array.from(new Map(allTracks.map((t) => [t.id, t])).values());
              const shuffled = uniqueTracks.sort(() => Math.random() - 0.5).slice(0, 15);

              const tracks = shuffled.map((track) => ({
                id: track.id,
                name: track.name,
                artist: track.artists?.[0]?.name || "Artista Desconocido",
                album: track.album?.name || "√Ålbum Desconocido",
                image: track.album?.images?.[0]?.url,
                preview: track.preview_url,
                uri: track.uri
              }));

              if (tracks.length === 0) {
                throw new Error("No se encontraron canciones para tu estado de √°nimo.");
              }

              const playlist = {
                id: Date.now(),
                name: `${detectedMood.charAt(0).toUpperCase() + detectedMood.slice(1)} Vibes`,
                mood: detectedMood,
                originalInput: userMood,
                tracks,
                createdAt: new Date().toISOString()
              };

              setGeneratedPlaylist(playlist);
              setView("playlist");
              setIsGenerating(false);
            } catch (error) {
              console.error("Error generando playlist:", error);
              alert(`Error al generar playlist: ${error.message || "Intenta de nuevo."}`);
              setIsGenerating(false);
            }
          };

          const savePlaylist = async () => {
            if (!user) {
              alert("Debes iniciar sesi√≥n para guardar playlists");
              return;
            }

            const payload = {
              user_id: user.id,
              name: generatedPlaylist.name,
              mood: generatedPlaylist.mood,
              playlist: generatedPlaylist.tracks
            };

            const res = await fetch("http://localhost:3000/save-playlist", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });

            if (res.ok) {
              alert("Playlist guardada!");
              loadUserPlaylists(user.id);
            } else {
              alert("Error al guardar playlist");
            }
          };

          const sharePlaylist = (playlist) => {
            const shareUrl = `${window.location.origin}/playlist/${playlist.id}`;
            navigator.clipboard.writeText(shareUrl);
            alert("¬°Link copiado al portapapeles!");
          };

          const exportToSpotify = () => {
            alert(
              "Para exportar a Spotify necesitas conectar tu cuenta (OAuth). Esta funcionalidad requiere un servidor backend adicional."
            );
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-green-50 via-blue-50 to-purple-50">
              <Navigation user={user} setView={setView} handleLogout={handleLogout} />

              {view === "home" && (
                <HomeView
    userMood={userMood}
    setUserMood={setUserMood}
    generatePlaylistFromMood={generatePlaylistFromMood}
    isGenerating={isGenerating}
    recommendations={recommendations}
                />
              )}

              {view === "login" && (
                <LoginView
                  loginData={loginData}
                  setLoginData={setLoginData}
                  handleLogin={handleLogin}
                  setView={setView}
                />
              )}

              {view === "register" && (
                <RegisterView
                  registerData={registerData}
                  setRegisterData={setRegisterData}
                  handleRegister={handleRegister}
                  setView={setView}
                />
              )}

              {view === "playlist" && (
                <PlaylistView
    generatedPlaylist={generatedPlaylist}
    user={user}
    savePlaylist={savePlaylist}
    sharePlaylist={sharePlaylist}
    exportToSpotify={exportToSpotify}
    setView={setView}
    likedTrackIds={likedTrackIds}
    onLikeChange={handleLikeChange}
                />
              )}

              {view === "profile" && user && (
                <ProfileView
    userStats={userStats}
    savedPlaylists={savedPlaylists}
    setView={setView}
    setGeneratedPlaylist={setGeneratedPlaylist}
    sharePlaylist={sharePlaylist}
    likedSongsCount={likedSongs.length}
                />
              )}

              {view === "liked" && user && (
  <LikedSongsView
    userId={user.id}
    likedSongs={likedSongs}
    setView={setView}
    likedTrackIds={likedTrackIds}
    onLikeChange={handleLikeChange}
  />
)}

            </div>
          );
        }

        // Renderizar la aplicaci√≥n
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<SpotifyPlaylistGenerator />);
    </script>
</body>
</html>